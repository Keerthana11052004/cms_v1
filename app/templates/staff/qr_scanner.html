{% extends 'base_logged_in.html' %}
{% block title %}Biometric Scanner{% endblock %}
{% block main_content %}
<!-- CSRF Token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token() }}">
<script>
  // Debug CSRF token on page load
  document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    console.log('Page loaded - CSRF Token:', csrfToken);
  });
</script>
<style>
  .back-btn {
    position: fixed;
    top: 24px;
    right: 24px;
    z-index: 1000;
    background: #6c757d;
    border: none;
    color: #fff;
    font-size: 1.2rem;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .back-btn:hover {
    background: #5a6268;
    transform: scale(1.08);
    box-shadow: 0 4px 16px rgba(0,0,0,0.18);
  }
  .scanner-card {
    font-size: 1.1rem;
    max-width: 900px;
    margin: 0 auto;
    box-shadow: 0 2px 16px rgba(0,0,0,0.08);
    border-radius: 1rem;
  }
  .scanner-card .card-header {
    font-size: 1.4rem;
    font-weight: 700;
    padding: 1rem 1rem 0.8rem 1rem;
    background: linear-gradient(90deg, #1976d2 0%, #64b5f6 100%);
    color: #fff;
    border-radius: 1rem 1rem 0 0;
    text-align: center;
  }
  .scanner-card .card-body {
    padding: 1.8rem 1.8rem 1.5rem 1.8rem;
  }
  .scanner-btn {
    font-size: 1.05em;
    padding: 0.6rem 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    border: none;
    color: #fff;
    transition: background 0.2s, box-shadow 0.2s, transform 0.2s;
    box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    background: linear-gradient(90deg, #ff512f 0%, #dd2476 100%);
  }
  .scanner-btn:hover, .scanner-btn:focus {
    transform: scale(1.05);
    background: linear-gradient(90deg, #dd2476 0%, #ff512f 100%);
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    color: #fff;
  }
  .manual-btn {
    background: linear-gradient(90deg, #36d1c4 0%, #1e90ff 100%);
  }
  .manual-btn:hover, .manual-btn:focus {
    background: linear-gradient(90deg, #1e90ff 0%, #36d1c4 100%);
    color: #fff;
  }
  
  /* Mobile Responsiveness */
  @media (max-width: 1199.98px) {
    .scanner-card .card-header {
      font-size: 1.4rem;
      padding: 1.1rem 1.1rem 0.8rem 1.1rem;
    }
  }
  
  @media (max-width: 991.98px) {
    .scanner-card .card-header {
      font-size: 1.3rem;
      padding: 1rem 1rem 0.7rem 1rem;
    }
  }
  
  @media (max-width: 767.98px) {
    .scanner-card .card-header {
      font-size: 1.2rem;
      padding: 0.9rem 0.9rem 0.6rem 0.9rem;
    }
  }
  
  @media (max-width: 575.98px) {
    .scanner-card .card-header {
      font-size: 1.2rem;
      padding: 0.9rem 0.9rem 0.5rem 0.9rem;
    }
  }
  
  @media (max-width: 375px) {
    .scanner-card .card-header {
      font-size: 1rem;
      padding: 0.8rem 0.8rem 0.4rem 0.8rem;
    }
  }
</style>
<button class="back-btn" id="backBtn" data-href="{{ dashboard_url }}" title="Back to Dashboard">
  <i class="bi bi-arrow-left"></i>
</button>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const backBtn = document.getElementById('backBtn');
    if (backBtn) {
        backBtn.addEventListener('click', function() {
            window.location.href = this.getAttribute('data-href');
        });
    }
});
</script>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="card scanner-card">
        <div class="card-header text-center">
          üñ®Ô∏è Biometric Scanner
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-12 mb-4">
              <div class="card h-100">
                <div class="card-header">
                  <h5 class="card-title mb-0">Biometric Meal Verification</h5>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="biometric_id" class="form-label">Biometric User ID (Device: 192.168.105.201)</label>
                    <input type="text" class="form-control" id="biometric_id" placeholder="Enter biometric user ID">
                    <small class="form-text text-muted">Enter the user ID from the consumption verification biometric device</small>
                  </div>
                  <button id="processBiometric" class="scanner-btn manual-btn w-100 mb-2">Process Meal Consumption</button>
                                  
                  <!-- Container for the four buttons in two columns -->
                  <div class="row mt-2">
                    <div class="col-md-6 pe-md-1">
                      <button id="connectBiometric" class="scanner-btn w-100" style="font-size: 0.9em; padding: 0.5rem 0.75rem;">Connect to Device</button>
                    </div>
                    <div class="col-md-6 ps-md-1">
                      <button id="clearOldPunches" class="scanner-btn w-100" style="background: linear-gradient(90deg, #ff8c00 0%, #ff6600 100%); font-size: 0.9em; padding: 0.5rem 0.75rem;">Clear Old Punches</button>
                    </div>
                  </div>
                                  
                  <div class="row mt-2">
                    <div class="col-md-6 pe-md-1">
                      <button id="syncBiometricUsers" class="scanner-btn w-100" style="background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%); font-size: 0.9em; padding: 0.5rem 0.75rem;">Sync Users</button>
                    </div>
                    <div class="col-md-6 ps-md-1">
                      <button id="clearOldPunches" class="scanner-btn w-100" style="background: linear-gradient(90deg, #ff8c00 0%, #ff6600 100%); font-size: 0.9em; padding: 0.5rem 0.75rem;">Keep Today</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Results Modal -->
<div class="modal fade" id="resultModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Biometric Scan Result</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="resultContent"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
<!-- Include HTML5-QRCode library -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

<script>
let isProcessingQR = false; // Flag to prevent multiple simultaneous QR processing

// Biometric scan functionality
document.getElementById('processBiometric').addEventListener('click', function() {
  const biometricId = document.getElementById('biometric_id').value.trim();
  if (biometricId) {
    processBiometricScan(biometricId);
    document.getElementById('biometric_id').value = '';
  } else {
    alert('Please enter biometric user ID');
  }
});

// Connect to biometric consumption device
document.getElementById('connectBiometric').addEventListener('click', function() {
  // This would typically establish a connection to the biometric device
  // For now, we'll just show a message
  const resultContent = document.getElementById('resultContent');
  resultContent.innerHTML = `
    <div class="alert alert-info">
      <h6>‚ÑπÔ∏è Biometric Device Connection</h6>
      <p>Connecting to consumption verification biometric device at IP: 192.168.105.201</p>
      <p>In a real implementation, this would establish a connection to the ESSL MB160 device for meal consumption verification.</p>
    </div>
  `;
  const modal = new bootstrap.Modal(document.getElementById('resultModal'));
  modal.show();
});



function processBiometricScan(biometricId) {
  // Prevent processing multiple requests simultaneously
  if (isProcessingQR) {
    console.log("Biometric scan is already being processed, ignoring duplicate request");
    return;
  }
  
  isProcessingQR = true;
  
  // Debug CSRF token
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
  console.log('CSRF Token for biometric scan:', csrfToken);
  
  // Use the new biometric consumption endpoint for meal verification
  fetch('/cms/staff/scan_biometric_consumption', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken
    },
    body: JSON.stringify({
      user_id: biometricId
    })
  })
  .then(response => {
    console.log('Biometric consumption scan response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    console.log("Biometric consumption scan backend response data:", data);
    const resultContent = document.getElementById('resultContent');
    
    let bookingDetailsHtml = '';
    let alertClass;
    let icon;
    let statusTextForDisplay;
    let statusClassForDisplay;

    if (data.message.includes('already been consumed')) {
        alertClass = 'danger'; // Red for already consumed
        icon = '‚ùå';
        statusTextForDisplay = 'Consumed (Already Scanned)'; // More descriptive
        statusClassForDisplay = 'danger';
    } else if (data.message.includes('Meal Consumed Successfully')) {
        alertClass = 'success'; // Green for first successful scan
        icon = '‚úÖ';
        statusTextForDisplay = 'Consumed'; // Standard consumed status
        statusClassForDisplay = 'success';
    } else if (data.success) {
        alertClass = 'success'; // Green for other successful operations
        icon = '‚úÖ';
        statusTextForDisplay = data.booking ? (data.booking.status || 'Success') : 'Success';
        statusClassForDisplay = 'success';
    } else {
        alertClass = 'danger'; // Red for other errors
        icon = '‚ùå';
        statusTextForDisplay = data.booking ? (data.booking.status || 'Error') : 'Error';
        statusClassForDisplay = 'danger';
    }

    if (data.booking) {
      bookingDetailsHtml = `
        <hr>
        <p><strong>Employee:</strong> ${data.booking.employee_name}</p>
        <p><strong>ID:</strong> ${data.booking.employee_id}</p>
        <p><strong>Unit:</strong> ${data.booking.unit}</p>
        <p><strong>Date:</strong> ${data.booking.date}</p>
        <p><strong>Shift:</strong> ${data.booking.shift}</p>
        <p><strong>Status:</strong> <span class="badge bg-${statusClassForDisplay}">${statusTextForDisplay}</span></p>
        ${data.booking.processed_at ? `<p><strong>Processed at:</strong> ${data.booking.processed_at}</p>` : (data.success ? `<p><strong>Processed at:</strong> ${new Date().toLocaleString()}</p>` : '')}
      `;
    }

    resultContent.innerHTML = `
      <div class="alert alert-${alertClass}">
        <h6>${icon} ${data.message}</h6>
        ${bookingDetailsHtml}
        ${data.trace ? `<pre style='max-width:100%;overflow:auto;'>${data.trace}</pre>` : ''}
      </div>
    `;
    
    // Show modal
    const modalElement = document.getElementById('resultModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Automatically close modal after 2.5 seconds for both success and error messages
    setTimeout(() => {
      modal.hide();
    }, 2500);
    
    // Reset processing flag after a delay to allow for proper display
    setTimeout(() => {
      isProcessingQR = false;
    }, 3000);
  })
  .catch(error => {
    console.error('Biometric scan error:', error);
    const resultContent = document.getElementById('resultContent');
    
    let errorMessage = error.message || 'Unknown error';
    let troubleshooting = '';
    
    if (errorMessage.includes('CSRF')) {
      troubleshooting = '<p><strong>Solution:</strong> Please refresh the page and try again.</p>';
    } else if (errorMessage.includes('HTTP error')) {
      troubleshooting = '<p><strong>Solution:</strong> Server error. Please check if the application is running properly.</p>';
    } else {
      troubleshooting = '<p><strong>Solution:</strong> Please check the biometric user ID and try again.</p>';
    }
    
    resultContent.innerHTML = `
      <div class="alert alert-danger">
        <h6>‚ùå Error processing biometric scan</h6>
        <p>Error details: ${errorMessage}</p>
        ${troubleshooting}
        <p><small>If this error persists, try refreshing the page and try again.</small></p>
      </div>
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('resultModal'));
    modal.show();
    
    // Reset processing flag on error
    setTimeout(() => {
      isProcessingQR = false;
    }, 3000);
  });
}

// Clear old punches keeping today's data
document.getElementById('clearOldPunches').addEventListener('click', function() {
  if (confirm('‚ö†Ô∏è WARNING: This will attempt to remove all punch data except for today\'s records. NOTE: The device may not support selective deletion, in which case you\'ll need to clear all data. Continue?')) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    fetch('/cms/staff/clear_old_punches', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    })
    .then(response => response.json())
    .then(data => {
      const resultContent = document.getElementById('resultContent');
      let alertClass = data.success ? 'success' : 'warning'; // Use warning for partial success
      let icon = data.success ? '‚úÖ' : '‚ö†Ô∏è';
      
      resultContent.innerHTML = `
        <div class="alert alert-${alertClass}">
          <h6>${icon} ${data.message}</h6>
        </div>
      `;
      
      const modal = new bootstrap.Modal(document.getElementById('resultModal'));
      modal.show();
      
      // Auto-close after 4 seconds
      setTimeout(() => {
        modal.hide();
      }, 4000);
    })
    .catch(error => {
      const resultContent = document.getElementById('resultContent');
      resultContent.innerHTML = `
        <div class="alert alert-danger">
          <h6>‚ùå Error processing punches</h6>
          <p>${error.message}</p>
        </div>
      `;
      
      const modal = new bootstrap.Modal(document.getElementById('resultModal'));
      modal.show();
    });
  }
});

// Sync CMS users to biometric device
document.getElementById('syncBiometricUsers').addEventListener('click', function() {
  if (confirm('‚ö†Ô∏è This will sync all users from your CMS database to the biometric device. Continue?')) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    fetch('/cms/staff/sync_biometric_users', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      }
    })
    .then(response => response.json())
    .then(data => {
      const resultContent = document.getElementById('resultContent');
      let alertClass = data.success ? 'success' : 'danger';
      let icon = data.success ? '‚úÖ' : '‚ùå';
      
      resultContent.innerHTML = `
        <div class="alert alert-${alertClass}">
          <h6>${icon} ${data.message}</h6>
        </div>
      `;
      
      const modal = new bootstrap.Modal(document.getElementById('resultModal'));
      modal.show();
      
      // Auto-close after 3 seconds
      setTimeout(() => {
        modal.hide();
      }, 3000);
    })
    .catch(error => {
      const resultContent = document.getElementById('resultContent');
      resultContent.innerHTML = `
        <div class="alert alert-danger">
          <h6>‚ùå Error syncing users</h6>
          <p>${error.message}</p>
        </div>
      `;
      
      const modal = new bootstrap.Modal(document.getElementById('resultModal'));
      modal.show();
    });
  }
});
</script>
{% endblock %}